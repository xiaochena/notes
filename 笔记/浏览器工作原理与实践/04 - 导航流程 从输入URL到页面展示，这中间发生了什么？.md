# 04 - 从输入URL到页面展示，这中间发生了什么？

![04-1](img/04/04-1.png)

从输入URL**到页面展示整个过程需要各个进程之间的配合**

- 浏览器进程：负责用户交互、子进程管理和文件储存等功能。

- 网络进程：面向渲染进程和浏览器进程等提供网络下载功能。

- 渲染进程：把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。

  因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利 用浏览器漏洞对系统进行攻击，所以运行在**渲染进程里面的代码是不被信任的**。因此为了保证系统的安全 Chrome 会让渲染进程运行在安全沙箱里

**完整的流程：**

- 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给**网络进程**。
- 然后，在网络进程中发起真正的 URL 请求。
- 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给**浏览器进程**。
- 浏览器进程接收到网络进程的响应头数据之后，发送 **“提交导航 (CommitNavigation)”**  消息到渲染进程；
- 渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；
- 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解 析页面数据了”。
- 浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新 浏览器进程中的页面状态。

### 1.输入URL

地址栏会判断输入的关键字是**搜索内容**，还是**请求的 URL。**如果判断输入内容符合 URL 规则，那么地址栏会根据规则加上**HTTP**或 **HTTPS**

> 浏览器还给了当前页面一次执行 beforeunload 事件的机会，beforeunload 事件允许页面在退出之前执行一些数据清理操作，可以通过 beforeunload 事件来取消导 航，让浏览器不再执行任何后续工作。

### 2. URL 请求过程

- 浏览器进程会**通过进程间通信（IPC）把 URL 请 求发送至网络进程**、
- **查找本地缓存**是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；

- 如果在缓存中没有该资源则**进行 DNS 解析获取请求域名的服务器 IP 地址。**
- **构建请求行、请求头**，后向服务器发送构建的请求信息。
- 服务器接收到请求信息后会**根据请求信息生成响应数据并发给网络进程**
- 等网络进程接收了响应行和响应头之后，就**开始解析响应头的内容**了。

### 3.响应数据类型处理

浏览器通过Content-Type来区分响应类型。**Content-Type 是 HTTP 响应头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型**

-  **Content-type:text/html：**是告诉浏览器，服 务器返回的数据是 **HTML 格式**。
-  **Content-Type:application/octet-stream：**浏览器会按照**下载类型**来处理该请求

> 如果服务器配置 Content-Type 不正确，比如将 text/html 类型配置成 application/octet-stream 类型，那么浏览器可能会曲解文件内容，将一个本来是用 来展示的页面，变成了一个下载文件。

如果 Content-Type 字段的值被浏 览器判断为**下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航 流程就此结束。**

但如果是 HTML，那么浏览器则会继续进行导航流程。**准备渲染进程**。

### 4. 准备渲染进程















