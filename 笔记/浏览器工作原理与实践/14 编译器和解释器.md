# 14 | 编译器和解释器：V8是如何执行一段JavaScript代码的？

**编译器（Compiler）、解释器（Interpreter）、抽象语法树（AST）、字节码（Bytecode）、即时编译器（JIT）**

## 编译器和解释器

- 编译型语言如 C/C++、GO ：在程序执行之前，需要经过编译器的编译过程，**依次对源代码进行词法分析、语法分析，生成抽象语法树（AST），然后是优化代码，最后再生成处理器能够理解的机器码。** ，编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时，都可以直接运行该二进制文件，而不需要再次重新编译了。**
- 解释型语言 如 Python、JavaScript：在每次运行时都需要通过解释器对程序进行动态解释和执行。解**释器也会对源代码进行词法分析、语法分析，并生成抽象语法树（AST），不过它会再基于抽象语法树生成字节码，最后再根据字节码来执行程序、输出结果。**
![14 编译器和解释器-2023-10-03-17-59-59](/attachments/14%20编译器和解释器-2023-10-03-17-59-59.png)
## V8 是如何执行一段 JavaScript 代码的
V8 在执行过程中既有**解释器 Ignition**，又有**编译器 TurboFan。**
![14 编译器和解释器-2023-10-03-20-28-53](/attachments/14%20编译器和解释器-2023-10-03-20-28-53.png)

### 1. 将源代码转换为抽象语法树（AST）并生成执行上下文
无论是解释型语言还是编译型语言，在编译过程中，它们都会生成一个 AST。它的作用是将源代码的语法结构以一种抽象的方式表示出来，以便于计算机程序在分析、转换、优化和执行代码时能够更轻松地理解和操作代码。

代码经过javascript-ast站点处理后，生成的 AST 结构
```jsx
var myName = "小陈啊"
function foo(){
  return 23;
}
myName = "xiaochena"
foo()
```
![14 编译器和解释器-2023-10-03-21-08-22](/attachments/14%20编译器和解释器-2023-10-03-21-08-22.svg)

AST的主要作用包括：

- 语法分析：AST将源代码转换成一种计算机可理解的形式，有助于识别语法错误和验证代码的正确性。
- 代码优化：编译器可以使用AST来进行代码优化，例如删除冗余代码、提高执行效率等。
- 代码生成：编译器可以基于AST生成目标代码，用于最终的程序执行。
- 静态分析：AST可用于静态代码分析工具，帮助检测代码中的潜在问题，如安全漏洞或性能瓶颈。
- 代码重构：开发工具可以使用AST来自动重构代码，改进代码结构和可读性。

### 生成字节码
**字节码就是介于 AST 和机器码之间的一种代码。但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行。**
![14 编译器和解释器-2023-10-03-21-40-55](/attachments/14%20编译器和解释器-2023-10-03-21-40-55.png)

### 3. 执行代码
**解释器 Ignition 除了负责生成字节码之外，它还有另外一个作用，就是解释执行字节码。** 第一次执行的字节码，解释器 `Ignition` 会逐条解释执行。如果发现有一段代码被重复执行多次，这种就称为**热点代码（HotSpot）** 后台的编译器 `TurboFan` 就会把该段热点的字节码编译为高效的机器码，然后当再次执行这段被优化的代码时，只需要执行编译后的机器码就可以了。

**即时编译（JIT）**：V8 使用了“字节码 +JIT”，就是指解释器 Ignition 在解释执行字节码的同时，收集代码信息，当它发现某一部分代码变热了之后，TurboFan 编译器便闪亮登场，把热点的字节码转换为机器码，并把转换后的机器码保存起来，以备下次使用。

![14 编译器和解释器-2023-10-03-21-44-42](/attachments/14%20编译器和解释器-2023-10-03-21-44-42.png)